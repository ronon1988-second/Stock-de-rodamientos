rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Reglas para la colección 'users'
    match /users/{userId} {
      // Los administradores pueden leer la lista completa de usuarios.
      allow list: if request.auth != null &&
                   get(/databases/$(database)/documents/roles/$(request.auth.uid)).data.role == 'admin';
      
      // Cualquier usuario autenticado puede leer el perfil de otro usuario individualmente.
      allow read: if request.auth != null;

      // Un usuario solo puede crear o actualizar su propio perfil.
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Reglas para la colección 'roles'
    match /roles/{userId} {
      // Cualquier usuario autenticado puede leer un rol individual.
      allow read: if request.auth != null;

      // Solo los administradores pueden escribir (crear/actualizar) roles.
      allow write: if request.auth != null &&
                    get(/databases/$(database)/documents/roles/$(request.auth.uid)).data.role == 'admin';
    }

    // El resto de las colecciones pueden ser leídas por cualquier usuario autenticado por ahora.
    // Esto se puede restringir más adelante si es necesario.
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}
