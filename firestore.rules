rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Los administradores pueden leer la lista completa de usuarios.
    // También pueden eliminar el documento de un usuario.
    match /users/{userId} {
      allow list, delete: if request.auth != null &&
                   get(/databases/$(database)/documents/roles/$(request.auth.uid)).data.role == 'admin';
      
      // Cualquier usuario autenticado puede leer el perfil de otro usuario individualmente
      allow read: if request.auth != null;
      
      // Un usuario solo puede crear o actualizar su propio perfil.
      allow create, update: if request.auth != null && request.auth.uid == userId;
    }

    // Los administradores pueden leer, escribir o eliminar cualquier rol.
    match /roles/{roleId} {
      allow read, write, delete: if request.auth != null &&
                      get(/databases/$(database)/documents/roles/$(request.auth.uid)).data.role == 'admin';
    }

    // El resto de las coleacciones (inventario, sectores, etc.)
    // Asumimos por ahora que cualquier usuario autenticado puede leer y escribir.
    // En una app real, estas reglas deberían ser más específicas.
    match /inventory/{itemId} {
      allow read, write: if request.auth != null;
    }
    match /sectors/{sectorId} {
      allow read, write: if request.auth != null;
    }
    match /sectors/{sectorId}/machines/{machineId} {
      allow read, write: if request.auth != null;
    }
    match /machineAssignments/{assignmentId} {
      allow read, write: if request.auth != null;
    }
    match /usageLog/{logId} {
      allow read, write: if request.auth != null;
    }
  }
}
